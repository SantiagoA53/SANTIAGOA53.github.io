<!doctype html>
<html lang="es">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Scan & Add — Detectar Códigos de Barra</title>
    <style>
        :root {
            --bg: #0f1724;
            --card: #0b1220;
            --muted: #94a3b8;
            --accent: #7c3aed;
            --glass: rgba(255, 255, 255, 0.03);
            --radius: 14px;
            font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
        }

        * {
            box-sizing: border-box
        }

        html,
        body {
            height: 100%;
            margin: 0;
            background: linear-gradient(180deg, #041025 0%, #081427 60%);
            color: #e6eef8
        }

        .app {
            max-width: 1000px;
            margin: 28px auto;
            padding: 24px;
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.02), rgba(255, 255, 255, 0.01));
            border-radius: 20px;
            box-shadow: 0 8px 30px rgba(2, 6, 23, 0.6);
        }

        header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px
        }

        header .brand {
            display: flex;
            gap: 12px;
            align-items: center
        }

        .logo {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, var(--accent), #4f46e5);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700
        }

        h1 {
            font-size: 1.15rem;
            margin: 0
        }

        p.lead {
            margin: 0;
            color: var(--muted);
            font-size: 0.95rem
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr 380px;
            gap: 18px
        }

        .panel {
            background: var(--card);
            padding: 16px;
            border-radius: 16px
        }

        .camera-wrap {
            position: relative;
            overflow: hidden;
            border-radius: 12px;
            background: var(--glass);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 360px
        }

        video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 8px;
            background: #000
        }

        canvas {
            display: none
        }

        .overlay {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            padding: 12px
        }

        .controls {
            display: flex;
            gap: 8px
        }

        button {
            background: linear-gradient(90deg, var(--accent), #5b21b6);
            border: 0;
            padding: 10px 12px;
            border-radius: 10px;
            color: white;
            font-weight: 600;
            cursor: pointer
        }

        button.ghost {
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.06);
            color: var(--muted);
            font-weight: 600
        }

        .hint {
            position: absolute;
            left: 12px;
            top: 12px;
            background: rgba(0, 0, 0, 0.35);
            padding: 8px;
            border-radius: 10px;
            font-size: 0.85rem;
            color: var(--muted)
        }

        .list {
            max-height: 560px;
            overflow: auto;
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 10px
        }

        .item {
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.02), rgba(255, 255, 255, 0.01));
            padding: 12px;
            border-radius: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px
        }

        .meta {
            display: flex;
            flex-direction: column
        }

        .title {
            font-weight: 700
        }

        .sub {
            font-size: 0.85rem;
            color: var(--muted)
        }

        .price {
            font-weight: 800
        }

        dialog {
            border: 0;
            background: linear-gradient(180deg, rgba(2, 6, 23, 0.95), rgba(3, 7, 18, 0.9));
            color: var(--muted);
            padding: 0;
            border-radius: 14px;
            width: 420px
        }

        form.dialog-form {
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 12px
        }

        label {
            font-size: 0.85rem;
            color: var(--muted)
        }

        input[type=text],
        input[type=number],
        select {
            padding: 10px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.04);
            background: transparent;
            color: inherit
        }

        .row {
            display: flex;
            gap: 8px
        }

        .actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
            padding: 12px
        }

        .small {
            font-size: 0.85rem;
            color: var(--muted)
        }

        footer.small {
            margin-top: 12px;
            color: var(--muted);
            font-size: 0.85rem
        }

        @media (max-width:880px) {
            .grid {
                grid-template-columns: 1fr;
            }

            dialog {
                width: 92vw
            }
        }
    </style>
</head>

<body>
    <div class="app">
        <header>
            <div class="brand">
                <div class="logo">S</div>
                <div>
                    <h1>Scan & Add</h1>
                    <p class="lead">Escanea códigos de barra, completa y guarda.</p>
                </div>
            </div>
            <div>
                <button id="btnStart">Iniciar cámara</button>
            </div>
        </header>

        <div class="grid">
            <section class="panel">
                <div class="camera-wrap">
                    <div class="hint">Alineá el código de barras dentro del área</div>
                    <video id="video" autoplay muted playsinline></video>
                    <canvas id="canvas"></canvas>
                    <div class="overlay">
                        <div class="controls">
                            <button id="btnScan">Escanear ahora</button>
                            <button id="btnStop" class="ghost">Detener</button>
                        </div>
                    </div>
                </div>

                <div style="margin-top:12px;display:flex;justify-content:space-between;align-items:center">
                    <div class="small">Estado: <span id="status">inactivo</span></div>
                    <div class="small">Soporte BarcodeDetector: <span id="bdSupport">?</span></div>
                </div>
                <footer class="small">Nota: Para acceder a la cámara el sitio debe usar HTTPS o localhost.</footer>
            </section>

            <aside class="panel">
                <h3 style="margin-top:0">Productos guardados</h3>
                <div class="list" id="list"></div>
                <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end">
                    <button id="clearStorage" class="ghost">Limpiar</button>
                </div>
            </aside>
        </div>
    </div>

    <dialog id="dialog">
        <form method="dialog" class="dialog-form" id="productForm">
            <h3 style="margin:0;color:white">Agregar producto</h3>
            <input type="hidden" id="scannedRaw">

            <div>
                <label for="name">Nombre del producto</label>
                <input id="name" type="text" required placeholder="Ej: Galletitas de chocolate">
            </div>

            <div class="row">
                <div style="flex:1">
                    <label for="price">Precio</label>
                    <input id="price" type="number" step="0.01" required placeholder="0.00">
                </div>
                <div style="width:120px">
                    <label for="qty">Cantidad</label>
                    <input id="qty" type="number" min="1" value="1" required>
                </div>
            </div>

            <div>
                <label for="category">Categoría (opcional)</label>
                <input id="category" type="text" placeholder="Bebidas, Snacks...">
            </div>

            <div class="actions">
                <button id="cancel" class="ghost">Cancelar</button>
                <button id="save" type="submit">Guardar</button>
            </div>
        </form>
    </dialog>

    <script>
        (function () {
            // referencias DOM
            const video = document.getElementById('video');
            const canvas = document.getElementById('canvas');
            const ctx = canvas.getContext('2d');
            const btnStart = document.getElementById('btnStart');
            const btnStop = document.getElementById('btnStop');
            const btnScan = document.getElementById('btnScan');
            const statusEl = document.getElementById('status');
            const bdSupportEl = document.getElementById('bdSupport');
            const dialog = document.getElementById('dialog');
            const form = document.getElementById('productForm');
            const listEl = document.getElementById('list');
            const clearStorage = document.getElementById('clearStorage');

            let stream = null;
            let scanning = false;
            let detector = null;
            let rafId = null;

            // inicial
            bdSupportEl.textContent = ('BarcodeDetector' in window) ? 'Sí' : 'No';

            async function startCamera() {
                try {
                    stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' }, audio: false });
                    video.srcObject = stream;
                    scanning = true;
                    statusEl.textContent = 'activo';

                    if ('BarcodeDetector' in window) {
                        // formatos solo de códigos de barra (no QR)
                        const formats = ['ean_13', 'ean_8', 'code_128', 'code_39', 'code_93'];
                        try {
                            detector = new BarcodeDetector({ formats });
                        } catch (err) {
                            // algunos navegadores requieren que no se pase formats
                            detector = new BarcodeDetector();
                        }
                    } else {
                        detector = null;
                        alert('Este navegador no soporta BarcodeDetector para códigos de barras. Probá con Chrome o Edge.');
                    }

                    tick();
                } catch (e) {
                    console.error(e);
                    alert('No se pudo acceder a la cámara. Revisá permisos o conectá una cámara.');
                    statusEl.textContent = 'error';
                }
            }

            function stopCamera() {
                if (stream) {
                    for (const track of stream.getTracks()) track.stop();
                }
                stream = null;
                scanning = false;
                statusEl.textContent = 'inactivo';
                if (rafId) cancelAnimationFrame(rafId);
                rafId = null;
            }

            btnStart.addEventListener('click', () => { if (!scanning) startCamera(); });
            btnStop.addEventListener('click', () => { stopCamera(); });
            btnScan.addEventListener('click', () => { captureOnce(); });

            async function tick() {
                if (!scanning) return;
                if (video.readyState >= 2) {
                    canvas.width = video.videoWidth || 640;
                    canvas.height = video.videoHeight || 480;
                    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

                    if (detector) {
                        try {
                            // createImageBitmap funciona mejor en algunos contextos
                            const bitmap = await createImageBitmap(canvas);
                            const barcodes = await detector.detect(bitmap);
                            // bitmap.close(); // opcional
                            if (barcodes && barcodes.length) {
                                handleDetected(String(barcodes[0].rawValue || barcodes[0].rawData || ''));
                                return; // pausamos el loop hasta que el diálogo se cierre
                            }
                        } catch (err) {
                            console.warn('Error en detector.detect:', err);
                        }
                    }
                }
                rafId = requestAnimationFrame(tick);
            }

            async function captureOnce() {
                if (!scanning) {
                    alert('Iniciá la cámara primero');
                    return;
                }
                canvas.width = video.videoWidth || 640;
                canvas.height = video.videoHeight || 480;
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

                if (detector) {
                    try {
                        const bitmap = await createImageBitmap(canvas);
                        const barcodes = await detector.detect(bitmap);
                        if (barcodes && barcodes.length) {
                            handleDetected(String(barcodes[0].rawValue || barcodes[0].rawData || ''));
                            return;
                        }
                    } catch (err) {
                        console.warn('Error en captura manual:', err);
                    }
                }
                alert('No se detectó ningún código de barras. Alineá mejor e intentá otra vez.');
            }

            function handleDetected(raw) {
                // pausamos loop
                scanning = false;
                statusEl.textContent = 'detenido (detectado)';

                // rellenar campos
                const hidden = document.getElementById('scannedRaw');
                const nameInput = document.getElementById('name');
                const priceInput = document.getElementById('price');
                const qtyInput = document.getElementById('qty');
                const categoryInput = document.getElementById('category');

                hidden.value = raw;
                // intentamos inferir nombre simple (puede quedar el código)
                nameInput.value = raw;
                priceInput.value = '';
                qtyInput.value = 1;
                categoryInput.value = '';

                // abrir dialog
                try {
                    dialog.showModal();
                } catch (e) {
                    dialog.setAttribute('open', '');
                }
            }

            form.addEventListener('submit', (ev) => {
                ev.preventDefault();
                const item = {
                    id: Date.now(),
                    raw: document.getElementById('scannedRaw').value,
                    name: document.getElementById('name').value.trim() || 'Sin nombre',
                    price: parseFloat(document.getElementById('price').value) || 0,
                    qty: parseInt(document.getElementById('qty').value) || 1,
                    category: document.getElementById('category').value.trim() || ''
                };
                addItem(item);
                closeDialogAndResume();
            });

            document.getElementById('cancel').addEventListener('click', (e) => {
                e.preventDefault();
                closeDialogAndResume();
            });

            function closeDialogAndResume() {
                try { dialog.close(); } catch (e) { dialog.removeAttribute('open'); }
                if (stream) {
                    scanning = true;
                    statusEl.textContent = 'activo';
                    tick();
                } else {
                    statusEl.textContent = 'inactivo';
                }
            }

            // manejo de lista
            function renderList(items) {
                listEl.innerHTML = '';
                if (!items || items.length === 0) {
                    const n = document.createElement('div');
                    n.style.color = 'var(--muted)';
                    n.textContent = 'No hay productos aun.';
                    listEl.appendChild(n);
                    return;
                }
                for (const it of items) {
                    const el = document.createElement('div');
                    el.className = 'item';

                    const meta = document.createElement('div');
                    meta.className = 'meta';
                    const title = document.createElement('div');
                    title.className = 'title';
                    title.textContent = it.name;
                    const sub = document.createElement('div');
                    sub.className = 'sub';
                    sub.textContent = (it.category ? it.category + ' · ' : '') + 'Código: ' + it.raw;

                    meta.appendChild(title);
                    meta.appendChild(sub);

                    const right = document.createElement('div');
                    right.style.textAlign = 'right';
                    const price = document.createElement('div');
                    price.className = 'price';
                    price.textContent = '$ ' + formatCurrency(it.price);
                    const q = document.createElement('div');
                    q.className = 'sub';
                    q.textContent = 'x' + it.qty;

                    right.appendChild(price);
                    right.appendChild(q);

                    el.appendChild(meta);
                    el.appendChild(right);

                    listEl.appendChild(el);
                }
            }

            function addItem(item) {
                const items = loadItems();
                items.unshift(item);
                saveItems(items);
                renderList(items);
            }

            function formatCurrency(n) {
                return Number(n).toFixed(2);
            }

            function saveItems(items) {
                localStorage.setItem('scan_items_v1', JSON.stringify(items));
            }

            function loadItems() {
                try {
                    const raw = localStorage.getItem('scan_items_v1');
                    return raw ? JSON.parse(raw) : [];
                } catch (e) {
                    return [];
                }
            }

            clearStorage.addEventListener('click', () => {
                if (confirm('Borrar todos los productos guardados?')) {
                    localStorage.removeItem('scan_items_v1');
                    renderList([]);
                }
            });

            window.addEventListener('load', () => {
                renderList(loadItems());
                // no iniciamos cámara automáticamente
            });

            window.addEventListener('beforeunload', () => { stopCamera(); });
        })();
    </script>
</body>

</html>
